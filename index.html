<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet</title>
    <style>
        body {
            background-color: #123;
            color: #eee;
            font-size: 100%;
            font-family: Arial, Helvetica, sans-serif;
        }


        input {
            background-color: rgba(0,0,0, 0.3);
            border: none;
            color: #fff;
            padding: 0.2em;
        }

        th + th,
        td + td {
            padding-left: 0.4em;
        }

        th {
            text-align: left;
            padding-bottom: 0.4em;
        }

        .unstyled-list {
            padding-left: 0;
            list-style-type: none;
        }

        .wrapper {
            padding: 1em;
        }
        .wrapper__inner {
            margin-left: auto;
            margin-right: auto;
            max-width: 50rem;
        }
    </style>
</head>

<body class="wrapper">
    <h2 class="wrapper__inner">Time Entries</h2>
    <form class="wrapper__inner" id=timesheet>
        <table>
            <thead>
                <tr>
                    <th>Task</th>
                    <th>Time Start</th>
                    <th>Time End</th>
                    <th>Duration</th>
                    <th>Synced</th>
                </tr>
            </thead>
            <tbody id="time_entries">
                <tr data-new="task">
                    <td><input type="text" name="task"></td>
                    <td><input type="time" name="time_start"></td>
                    <td><input type="time" name="time_end"></td>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
        <h3>Task totals</h3>
        <ul data-task-totals class="unstyled-list"></ul>
        <p>Total: <output name="durationTotal"></output></p>

    </form>

    <template id="week_nav">
        <nav data-week-nav>
            <ul>
                <li data-next-week><a href="#"><time></time></a></li>
                <li data-current-week><time></time></li>
                <li data-previous-week><a href="#"><time></time></a></li>
            </ul>
        </nav>
    </template>

    <template id="entry_row">
        <tr>
            <td><input type="text" name="task"></td>
            <td><input type="time" name="time_start"></td>
            <td><input type="time" name="time_end"></td>
            <td><output name="duration"></output></td>
            <td><input type="checkbox"></td>
        </tr>
    </template>

    <template id="task_total">
        <li><span data-task></span> - <output name="taskTotal"></output> </li>
    </template>
    <script>
        const WEEK = 7 * 24 * 3600 * 1000;

        timesheet(document.getElementById('time_entries'))

        

        async function timesheet(el) {

            const rowTemplate = document.getElementById('entry_row');
            const taskTotalTemplate = document.getElementById('task_total');

            

            const store = Store(
                'timesheet',
                function hydrate(state) {
                    state.selectedWeek = state.selectedWeek || weekOfYear(new Date)
                    state.selectedWeek = parseInt(state.selectedWeek, 10)
                    console.log(state)
                    state.entries = state.entries.map(
                        ({ start, end, ...x }) => ({
                            start: new Date(start),
                            end: new Date(end),
                            ...x
                        })
                    ).filter(x => weekOfYear(x.start) == state.selectedWeek);
                    console.log(state)
                    return state;
                },
                {
                    selectedWeek: weekOfYear(new Date),
                    entries: []
                }
            );
            const model = Model([
                function updateEntry(state, ev) {
                    const { id, type, ...change } = ev
                    if ('change' != type) return state;

                    if (id) {
                        state.entries = state.entries.map(x => x.id == id ? { ...x, ...change } : x)
                    } else {
                        state.entries = [
                            ...state.entries,
                            {
                                id: Date.now(),
                                ...change
                            }
                        ];
                    }
                    return state;
                },
            ],
                await store.read()
            )


            el.addEventListener('focusout', function (ev) {
                if (ev.target.nodeName == 'INPUT') {
                    const input = ev.target;
                    const row = input.closest('tr');
                    if (!allInputsEntered(row)) return;

                    model.emit({
                        type: 'change',
                        id: parseInt(ev.target.closest('tr').id, 10),
                        task: row.querySelector('[name="task"]').value,
                        start: timeToDate(row.querySelector('[name="time_start"]').value),
                        end: timeToDate(row.querySelector('[name="time_end"]').value),
                    })
                }
            });

            el.addEventListener('focusin', function autofillTime(ev) {
                if (ev.target.nodeName == 'INPUT') {
                    const input = ev.target;
                    if (input.value || !['time_start', 'time_end'].includes(input.name)) {
                        return;
                    }

                    input.value = format24hour(new Date());
                }
            });

            model.listen(function render(state) {
                const newTask = el.querySelector('[data-new="task"]');
                newTask.querySelectorAll('input').forEach(x => x.value = '');
                let durationTotal = 0;
                const taskTotals = {};
                for (const entry of state.entries) {
                    let row = document.getElementById(entry.id);
                    if (!row) {
                        row = newTimeentryRow();
                        row.id = entry.id
                        if (newTask.nextElementSibling) {
                            el.insertBefore(row, newTask.nextElementSibling);
                        } else {
                            el.append(row);
                        }
                    }

                    row.querySelector('[name="task"]').value = entry.task;
                    row.querySelector('[name="time_start"]').value = format24hour(entry.start);
                    row.querySelector('[name="time_end"]').value = format24hour(entry.end);
                    const duration = calcDuration(entry);
                    row.querySelector('[name="duration"]').value = duration;
                    durationTotal += duration;
                    taskTotals[entry.task] = taskTotals[entry.task] || 0;
                    taskTotals[entry.task] += duration;
                }
                renderTaskTotals(taskTotals);

                //TODO make sure in scope of timesheet
                document.querySelector('[name="durationTotal"]').value = round1dp(durationTotal);
            })

            function renderTaskTotals(totals) {
                const elTotals = document.querySelector('[data-task-totals]')
                elTotals.innerHTML = '';
                for( let [task, total] of Object.entries(totals)) {
                    const li = newTasktotalItem();
                    li.querySelector('[data-task]').innerText = task;
                    li.querySelector('[name="taskTotal"]').value = total;
                    elTotals.append(li);
                }
            }

            model.listen(store.write);

            model.emit({ type: 'init' });

            function newTimeentryRow() {
                return rowTemplate.content.cloneNode(true).querySelector('tr')
            }

            function newTasktotalItem() {
                return taskTotalTemplate.content.cloneNode(true).querySelector('li')
            }


            function formatDurationDecimal(duration) {
                const HOUR = 60 * 60 * 1000;
                return Math.ceil((duration / HOUR) * 10) / 10
            }

            function round1dp(x) {
                return Math.round(x * 10) / 10
            }

            function calcDuration({ start, end }) {
                return start && end ? formatDurationDecimal(end.getTime() - start.getTime()) : 0
            }

            function timeToDate(val) {
                const date = new Date();
                const [hours, mins] = val.split(':')
                date.setHours(hours);
                date.setMinutes(mins);
                return date;
            }



            function format24hour(date) {
                return padNumber(2, date.getHours()) + ':' + padNumber(2, date.getMinutes());
            }

            function padNumber(l, n) { return `${n}`.padStart(l, '0'); }
        }

        function weekNav(el) {
            const model = Model(
                [],
                {
                    currWeek: new Date(),
                }
            );
        }
        /**
         * Creates model with given functions and state
         * @param fns reducers to update business logic
         * @param initialState initial state of model
         **/
        function Model(fns, initialState) {
            let state = { ...initialState };
            function emit(ev) {
                state = fns.reduce((s, fn) => fn(s, ev), state)
                listeners.forEach(fn => fn({ ...state }));
            }

            const listeners = [];
            function listen(fn) {
                listeners.push(fn);
            }
            return {
                emit,
                listen
            }
        }

        function Store(key, hydrateFn, initialState) {
            async function read() {
                let data = {};
                try {
                    data = JSON.parse(localStorage.getItem(key)) || initialState;
                } catch (e) {
                    console.error(e);
                    data.errors = [e];
                }
                return hydrateFn(data);
            }
            async function write(data) {
                localStorage.setItem(key, JSON.stringify(data));
            }
            return {
                read,
                write
            }
        }

        function allInputsEntered(el) {
            let entered = true;
            for (const input of el.querySelectorAll('input')) {
                if (!input.value) {
                    entered = false;
                    break;
                }
            }
            return entered;
        }

        function dateAdd(ms, date) {
            return new Date(date.getTime() + ms);
        }

        function isSameWeek(dateA, dateB) {
            return weekOfYear(dateA) == weekOfYear(dateB)
        }

        function weekOfYear(date) {
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            startOfYear.setDate(startOfYear.getDate() + (startOfYear.getDay() % 7))
            return Math.round((date - startOfYear) / WEEK)
        }


    </script>
</body>

</html>